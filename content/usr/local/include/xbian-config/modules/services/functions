#!/bin/bash
#
#Copyright 2012 CurlyMo <development@xbian.org>
#
#This file is part of XBian - XBMC on the Raspberry Pi.
#
#XBian is free software: you can redistribute it and/or modify it under the
#terms of the GNU General Public License as published by the Free Software
#Foundation, either version 3 of the License, or (at your option) any later
#version.
#
#XBian is distributed in the hope that it will be useful, but WITHOUT ANY
#WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
#FOR A PARTICULAR PURPOSE. See the GNU General Public License for more
#details.
#
#You should have received a copy of the GNU General Public License along
#with XBian. If not, see <http://www.gnu.org/licenses/>

# Get list of installed services
function getInstalledServicesFn() {
	INSTSERV=();
	SERVLIST=($SERVICES);
	for SERVRAW in ${SERVLIST[@]}; do
		NAME=${SERVRAW%:*};
		FOUNDsysv=$(ls /etc/init.d/ | grep -io "^$NAME*");
		FOUNDupstart=$(ls /etc/init/ | grep -io "^$NAME*");
		if [ ! -z "$FOUNDsysv" -o ! -z "$FOUNDupstart" ]; then
			INSTSERV+=($SERVRAW);
		fi
	done
}

function getServiceAutoStartStatusFn() {
	[ -z "$1" ] && return 0
	lsnr=$(ls /etc/rc2.d/ | grep -c -io "S[0-9]\{1,\}$1")
	if [ "$lsnr" = '0' ]; then
		lsnr=$(ls /etc/init/ | grep -c -io "$1.override")
		[ "$lsnr" = '1' ] && return 0
		lsnr=$(ls /etc/init/ | grep -c -io "$1.conf")
	fi
	return $lsnr
}

function getServiceRunningStatusFn() {
	SERVICE=$1;
	SERVCONF=${SERVCONF#:*};
	SERVCONF=${SERVCONF//,/ /};
	RUNNING=0;
	if [ ${#DAEMONS[@]} -eq 0 ]; then
		if [[ "$PROCESSES" =~ "$SERVICE" ]]; then
			RUNNING=1;
		fi
	else
		for DAEMON in ${DAEMONS[@]}; do
			if [[ "$PROCESSES" =~ "$DAEMON" ]]; then
				RUNNING=$(($RUNNING+1));
			fi
		done
		if [ $RUNNING -eq ${#DAEMONS[@]} ]; then
			RUNNING=1;
		else
			RUNNING=0;
		fi
	fi
	return $RUNNING;
}

function getServiceNameFn() {
	IFS=$'\n';
	SERVCONF=($(echo -e "$SERVICES"));
	IFS=$ORIGINALIFS;
	I=0;
	for SERVRAW in ${SERVCONF[@]}; do
		SERV=${SERVRAW%:*};
		FOUND=$(ls /etc/init.d/ | grep -i "^$SERV*");
		if [ ! -z "$FOUND" ]; then
			if [ $I -eq $1 ]; then
				break;
			fi
			I=$(($I+1));
		fi 
	done
	NAME=$(ls -Al /etc/init.d/ | grep -m1 "$SERV" | awk '{print $9}');
}

function getServiceIDFn() {
	I=0;
	
	for SERVRAW in ${INSTSERV[@]}; do
		SERV=${SERVRAW%:*};

		if [ "$SERV" == "$1" ]; then
			break;
		fi
		I=$(($I+1));
	done
	return $I;
}

function checkServiceExistsFn() {
	COMMAND="ls -Al /etc/init.d/ | awk '{print \$9}' | grep -c ^$1\$"
	if [ $(eval $COMMAND) -ge 1 ]; then
		return 1;
	else
		return 0;
	fi
}

function restartServiceFn() {
	getServiceNameFn $1;
	if [ -f "/etc/init.d/$NAME" ]; then
		/etc/init.d/$NAME restart &>/dev/null
		RETURN=$?;
		X=0;
		while [ $(getServiceRunningStatusFn $NAME; echo $?) -eq 0 ] || [ $X -lt 10 ]; do
			sleep 1;
			PROCESSES=$(ps -A);
			X=$(($X+1));
		done;
		return $RETURN;
	else
		return -1;
	fi
}

function startServiceFn() {
	getServiceNameFn $1;
	if [ -f "/etc/init.d/$NAME" ]; then
		/etc/init.d/$NAME start &>/dev/null
		RETURN=$?;
		X=0;
		while [ $(getServiceRunningStatusFn $NAME; echo $?) -eq 0 ] && [ $X -lt 10 ]; do
			sleep 1;
			PROCESSES=$(ps -A);
			X=$(($X+1));
		done;
		return $RETURN;
	else
		return 1;
	fi
}

function stopServiceFn() {
	getServiceNameFn $1;
	if [ -f "/etc/init.d/$NAME" ]; then
		/etc/init.d/$NAME stop &>/dev/null
		RETURN=$?;
		X=0;
		while [ $(getServiceRunningStatusFn $NAME; echo $?) -eq 1 ] && [ $X -lt 10 ]; do
			sleep 1;
			PROCESSES=$(ps -A);
			X=$(($X+1));
		done;
		return $RETURN;
	else
		return 1;
	fi
}

function disableAutoStartFn() {
	getServiceNameFn $1;
	if [ -f "/etc/init.d/$NAME" ]; then	
		update-rc.d $NAME remove &>/dev/null
		RETURN=$?;
		X=0;
		while [ $(getServiceAutoStartStatusFn $NAME; echo $?) -eq 1 ] && [ $X -lt 10 ]; do
			sleep 1;
			X=$(($X+1));
		done;
		if [ $X -eq 9 ]; then
			RETURN=0;
		fi
		return $RETURN;
	else
		return 1;
	fi
}

function enableAutoStartFn() {
	getServiceNameFn $1;
	if [ -f "/etc/init.d/$NAME" ]; then
		update-rc.d $NAME defaults &>/dev/null
		RETURN=$?;
		X=0;
		while [ $(getServiceAutoStartStatusFn $NAME; echo $?) -eq 0 ] && [ $X -lt 10 ]; do
			sleep 1;
			X=$(($X+1));
		done;
		if [ $X -eq 9 ]; then
			RETURN=0;
		fi
		return $RETURN;
	else
		return 1;
	fi
}

function getServiceConfFn() {
	DATA=();
	I=0;

	for SERVRAW in ${INSTSERV[@]}; do
		if [ $I -eq $1 ]; then
			DATA[0]=${SERVRAW%:*};
			DATA[1]=${SERVRAW#*:}
			break;
		fi 
		I=$(($I+1));
	done
}

function updateServiceConfFn() {
	DATA=($2);
	if [ -f "$BASEPATH/config/services" ]; then
		sed -i "/${DATA[0]}:/d" $BASEPATH/config/services;
	fi
	echo "${DATA[0]}:${DATA[1]}" >> $BASEPATH/config/services;
	if [ -f "$BASEPATH/config/services" ] && [ $(cat $BASEPATH/config/services | grep -c "${DATA[0]}:${DATA[1]}" ) -eq 1 ]; then
		return 1;
	else
		return 0;
	fi
}

function deleteServiceFn() {
	DATA=($2);
	if [ -f "$BASEPATH/config/services" ]; then
		sed -i "/${DATA[0]}:/d" $BASEPATH/config/services;
	fi
	if [ -f "$BASEPATH/config/services" ] && [ $(cat $BASEPATH/config/services | grep -c "${DATA[0]}:") -eq 0 ]; then
		return 1;
	else
		return 0;
	fi
}